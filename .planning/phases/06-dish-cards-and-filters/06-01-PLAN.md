---
phase: 06-dish-cards-and-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/i18n/index.ts
  - lib/i18n/translations.ts
  - lib/types/menu.ts
  - lib/types/llm.ts
  - lib/openai.ts
  - hooks/useFilteredDishes.ts
autonomous: true
requirements:
  - DISH-02
  - DISH-05
  - DISH-06
  - FILT-01
  - FILT-02
  - FILT-03
  - FILT-04

must_haves:
  truths:
    - "useLanguage() hook returns current lang, setLang, and t() function"
    - "Language auto-detects from navigator.language on first visit"
    - "Language persists to localStorage on manual change"
    - "t() returns localized string for all 4 languages (FR/EN/TR/DE)"
    - "DietaryTag type includes 'spicy' alongside vegetarian/vegan/halal"
    - "LLM prompt instructs detection of spicy dishes"
    - "useFilteredDishes returns items matching all active dietary tags AND excluding all selected allergens"
  artifacts:
    - path: "lib/i18n/index.ts"
      provides: "LanguageProvider context + useLanguage hook"
      min_lines: 40
    - path: "lib/i18n/translations.ts"
      provides: "4-language dictionary with allergen labels, dietary tags, trust badges, disclaimer, filter labels, empty state"
      min_lines: 80
    - path: "hooks/useFilteredDishes.ts"
      provides: "useFilteredDishes hook with FilterState type"
      min_lines: 20
    - path: "lib/types/menu.ts"
      provides: "DietaryTag with 'spicy'"
      contains: "'spicy'"
    - path: "lib/types/llm.ts"
      provides: "dishResponseSchema with 'spicy' in dietary_tags enum"
      contains: "'spicy'"
  key_links:
    - from: "lib/i18n/index.ts"
      to: "lib/i18n/translations.ts"
      via: "import translations"
      pattern: "import.*translations"
    - from: "hooks/useFilteredDishes.ts"
      to: "lib/types/menu.ts"
      via: "import MenuItem, DietaryTag, Allergen types"
      pattern: "import.*MenuItem.*menu"
---

<objective>
Create the i18n system, client-side filtering hook, and fix the 'spicy' dietary tag gap in the schema and LLM prompt.

Purpose: Provide the data layer and hooks that Plan 02's UI components will consume — language context, translation dictionary, filtering logic, and a complete dietary tag schema.
Output: `lib/i18n/` module, `hooks/useFilteredDishes.ts`, updated `DietaryTag` type and Zod schema with 'spicy'.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dish-cards-and-filters/06-RESEARCH.md
@lib/types/menu.ts
@lib/types/llm.ts
@lib/openai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create i18n system — LanguageProvider, useLanguage hook, and 4-language translation dictionary</name>
  <files>lib/i18n/index.ts, lib/i18n/translations.ts</files>
  <action>
Create the i18n module following the exact patterns from 06-RESEARCH.md Pattern 1 and Pattern 2.

**lib/i18n/translations.ts:**
- Export a `translations` constant with 4 top-level keys: `fr`, `en`, `tr`, `de`
- Each language contains these keys (copy exact strings from RESEARCH.md Pattern 2):
  - `allergen_disclaimer` — localized allergen banner text
  - `trust_verified`, `trust_inferred` — trust badge labels
  - `filter_vegetarian`, `filter_vegan`, `filter_spicy` — dietary filter chip labels
  - `filter_no_gluten`, `filter_no_dairy`, `filter_no_nuts`, `filter_no_peanuts`, `filter_no_eggs`, `filter_no_fish`, `filter_no_shellfish` — allergen exclusion filter labels
  - `allergen_gluten` through `allergen_molluscs` — all 14 EU allergen labels
  - `tag_vegetarian`, `tag_vegan`, `tag_halal`, `tag_spicy` — dietary tag labels for cards
  - `empty_filters` — empty state message
  - `lang_fr`, `lang_en`, `lang_tr`, `lang_de` — language names for switcher
- Use `as const` for type safety
- Add `menu_header` key with localized "{count} dish(es) found" text for all 4 languages
- Add `clear_filters` key with localized "Clear filters" text

**lib/i18n/index.ts:**
- `'use client'` directive at top
- Export `Lang` type: `'fr' | 'en' | 'tr' | 'de'`
- Export `SUPPORTED_LANGS` constant array
- Create `LanguageContext` with `createContext`
- `detectBrowserLang()` function: reads `navigator.language`, maps first 2 chars to supported Lang, defaults to `'fr'`
- `LanguageProvider` component:
  - `useState<Lang>('fr')` — SSR-safe default, NEVER read localStorage in initializer (hydration mismatch pitfall)
  - `useEffect` on mount: read `localStorage.getItem('nom_lang')`, fall back to `detectBrowserLang()`
  - `setLang(l)`: writes to localStorage + updates state
  - `t(key)`: looks up `translations[lang][key]`, falls back to key string
  - Provides `{ lang, setLang, t }` via context
- Export `useLanguage` hook: `useContext(LanguageContext)`

SSR safety is critical: initial render must use `'fr'` default. The `useEffect` correction happens client-side only. See RESEARCH Pitfall 1.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in the new files. Verify that `lib/i18n/index.ts` has `'use client'` directive. Verify translations.ts has all 4 language blocks with identical key sets.
  </verify>
  <done>
`useLanguage()` hook is importable and returns `{ lang, setLang, t }`. Translation dictionary covers all allergen labels (14), dietary tags (4), trust badges (2), filter labels, disclaimer, empty state, and language names in FR/EN/TR/DE. No hydration mismatch risk — `useState` initializes to `'fr'`, `useEffect` corrects from localStorage/browser.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 'spicy' to DietaryTag type, Zod schema, and LLM system prompt</name>
  <files>lib/types/menu.ts, lib/types/llm.ts, lib/openai.ts</files>
  <action>
Close the 'spicy' schema gap identified in 06-RESEARCH.md Pitfall 2.

**lib/types/menu.ts:**
- Update `DietaryTag` union type from `'vegetarian' | 'vegan' | 'halal'` to `'vegetarian' | 'vegan' | 'halal' | 'spicy'`
- No other changes to this file

**lib/types/llm.ts:**
- Update the `dietary_tags` field in `dishResponseSchema` from `z.enum(['vegetarian', 'vegan', 'halal'])` to `z.enum(['vegetarian', 'vegan', 'halal', 'spicy'])`
- No other changes to this file

**lib/openai.ts:**
- In `MENU_PARSE_SYSTEM_PROMPT`, update section 6 (DIETARY TAGS) to add:
  `- spicy: the dish is notably spicy or contains hot peppers/chili`
- Keep the existing vegetarian/vegan/halal instructions unchanged
- Keep the "Do NOT tag unless you are confident" warning

No DB migration needed — `dietary_tags` is stored as `text[]` in PostgreSQL (not an enum). The column already accepts any string values.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify `DietaryTag` includes `'spicy'`. Verify `dishResponseSchema` Zod enum includes `'spicy'`. Verify LLM prompt mentions spicy detection.
  </verify>
  <done>
`DietaryTag` type, Zod validation schema, and LLM prompt all include 'spicy'. New menu parses will detect and tag spicy dishes. No DB migration was needed (text[] column).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useFilteredDishes hook with AND-stacked dietary + allergen exclusion filters</name>
  <files>hooks/useFilteredDishes.ts</files>
  <action>
Create the filtering hook following 06-RESEARCH.md Pattern 3.

**hooks/useFilteredDishes.ts:**
- `'use client'` directive at top
- Import `useMemo` from React
- Import `MenuItem`, `DietaryTag`, `Allergen` types from `@/lib/types/menu`
- Export `FilterState` type: `{ dietaryTags: DietaryTag[]; excludeAllergens: Allergen[] }`
- Export `useFilteredDishes(items: MenuItem[], filters: FilterState): MenuItem[]` function:
  - Uses `useMemo` with `[items, filters]` dependency array
  - Dietary filter logic: if `filters.dietaryTags.length > 0`, dish must have ALL active dietary tags in its `dietary_tags` array (AND logic). If not, exclude.
  - Allergen exclusion logic: if `filters.excludeAllergens.length > 0`, dish must NOT contain ANY excluded allergen in its `allergens` array. If it does, exclude.
  - Both filters stack (AND): a dish must pass both checks to be included
  - If no filters are active, returns all items unchanged

Keep `useMemo` — explicit intent for array filtering, even with React 19 compiler. The dependency array is clear and the operation is a potentially large array filter.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the hook exports `FilterState` type and `useFilteredDishes` function.
  </verify>
  <done>
`useFilteredDishes` hook filters items by dietary tags (AND inclusion) and allergen exclusion (OR exclusion). Filters stack correctly — activating vegetarian + gluten-free shows only vegetarian dishes without gluten. Returns all items when no filters active. Memoized with `useMemo`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `lib/i18n/index.ts` exports `LanguageProvider`, `useLanguage`, `Lang`, `SUPPORTED_LANGS`
3. `lib/i18n/translations.ts` exports `translations` with all 4 languages having identical key sets
4. `lib/types/menu.ts` DietaryTag includes 'spicy'
5. `lib/types/llm.ts` Zod schema includes 'spicy' in dietary_tags enum
6. `lib/openai.ts` system prompt instructs spicy detection
7. `hooks/useFilteredDishes.ts` exports `FilterState` and `useFilteredDishes`
</verification>

<success_criteria>
- All 3 new files compile without errors
- i18n system provides complete 4-language dictionary for all UI strings needed by Plan 02
- DietaryTag + Zod schema + LLM prompt all include 'spicy' — future menu parses will detect spicy dishes
- useFilteredDishes correctly implements AND-stacked filtering with dietary inclusion + allergen exclusion
</success_criteria>

<output>
After completion, create `.planning/phases/06-dish-cards-and-filters/06-01-SUMMARY.md`
</output>
