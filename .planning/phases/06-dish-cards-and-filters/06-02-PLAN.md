---
phase: 06-dish-cards-and-filters
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - components/menu/DishCard.tsx
  - components/menu/AllergenBanner.tsx
  - components/menu/LangSwitcher.tsx
  - components/menu/FilterBar.tsx
  - components/menu/MenuShell.tsx
  - components/menu/MenuAccordion.tsx
  - app/menu/[id]/page.tsx
autonomous: false
requirements:
  - DISH-01
  - DISH-02
  - DISH-03
  - DISH-04
  - DISH-05
  - DISH-06
  - FILT-01
  - FILT-02
  - FILT-03
  - FILT-04

must_haves:
  truths:
    - "Each dish card shows translated name prominently, original name secondary, translated description, and price"
    - "Dish cards display in the user's selected language (FR/EN/TR/DE)"
    - "Each dish card displays a trust badge — neutral for verified, warm orange for inferred"
    - "Each dish card shows allergen chips in neutral/warm tones — never green"
    - "Each dish card shows dietary tags (vegetarian, vegan, halal, spicy)"
    - "A single discreet allergen disclaimer banner appears at the top of the menu page"
    - "A globe icon in the header opens a language switcher dropdown"
    - "Tapping a dietary filter chip immediately hides non-matching dishes"
    - "Tapping an allergen exclusion chip immediately hides dishes with that allergen"
    - "Filter combinations stack correctly — vegetarian + gluten-free works"
    - "Filters apply instantly with no API call"
    - "When filters are active, dishes display as a flat animated list (not accordion)"
    - "Empty filter state shows a message and clear-filters button"
  artifacts:
    - path: "components/menu/DishCard.tsx"
      provides: "Translated dish card with trust badge, allergens, dietary tags"
      min_lines: 40
    - path: "components/menu/AllergenBanner.tsx"
      provides: "Localized allergen disclaimer banner"
      min_lines: 10
    - path: "components/menu/LangSwitcher.tsx"
      provides: "Globe icon dropdown for FR/EN/TR/DE"
      min_lines: 30
    - path: "components/menu/FilterBar.tsx"
      provides: "Sticky horizontal chip filter bar (dietary + allergen exclusion)"
      min_lines: 50
    - path: "components/menu/MenuShell.tsx"
      provides: "Client coordinator holding language + filter state"
      min_lines: 40
    - path: "app/menu/[id]/page.tsx"
      provides: "Server Component passing data to MenuShell"
  key_links:
    - from: "components/menu/MenuShell.tsx"
      to: "lib/i18n/index.ts"
      via: "LanguageProvider wrapping all children"
      pattern: "LanguageProvider"
    - from: "components/menu/MenuShell.tsx"
      to: "hooks/useFilteredDishes.ts"
      via: "useFilteredDishes(items, filters)"
      pattern: "useFilteredDishes"
    - from: "components/menu/DishCard.tsx"
      to: "lib/i18n/index.ts"
      via: "useLanguage() for translations"
      pattern: "useLanguage"
    - from: "components/menu/FilterBar.tsx"
      to: "lib/i18n/index.ts"
      via: "useLanguage() for filter labels"
      pattern: "useLanguage"
    - from: "app/menu/[id]/page.tsx"
      to: "components/menu/MenuShell.tsx"
      via: "passes MenuWithItems data to client shell"
      pattern: "MenuShell.*menu"
---

<objective>
Build the dish card UI surface, filter bar, language switcher, allergen banner, and wire everything together through the MenuShell client coordinator.

Purpose: Present parsed dish data as translated, filterable cards with trust signals and allergen info — the core user-facing display surface of NOM.
Output: Complete `/menu/[id]` page with translated dish cards, sticky filter bar, language switching, and allergen disclaimer.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dish-cards-and-filters/06-RESEARCH.md
@.planning/phases/06-dish-cards-and-filters/06-01-SUMMARY.md
@lib/types/menu.ts
@lib/i18n/index.ts
@lib/i18n/translations.ts
@hooks/useFilteredDishes.ts
@components/menu/MenuAccordion.tsx
@app/menu/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DishCard, AllergenBanner, LangSwitcher, and FilterBar components</name>
  <files>components/menu/DishCard.tsx, components/menu/AllergenBanner.tsx, components/menu/LangSwitcher.tsx, components/menu/FilterBar.tsx</files>
  <action>
Create 4 new components following 06-RESEARCH.md patterns. All have `'use client'` directive and use `useLanguage()` from Plan 01.

**components/menu/DishCard.tsx** (Pattern 6 from RESEARCH):
- `'use client'`, imports `useLanguage` from `@/lib/i18n`
- Props: `{ item: MenuItem }`
- Card hierarchy (Claude's discretion — per CONTEXT.md):
  1. **Translated name** (prominent, `text-brand-white font-semibold text-sm`) — primary read
  2. **Original name** (smaller, `text-brand-muted text-xs`, only shown if different from translated) — for ordering at restaurant
  3. **Translated description** (small, `text-brand-muted text-xs`)
  4. **Price** (right-aligned on name row, `text-brand-orange font-semibold`)
  5. **Bottom row**: Trust badge + dietary tag chips + allergen chips
- Trust badge design:
  - `verified`: neutral muted (`bg-white/5 border-white/15 text-brand-muted`) — subtle, expected state
  - `inferred`: warm orange tint (`bg-brand-orange/8 border-brand-orange/15 text-brand-orange/70`) — draws attention without alarming
- Dietary tag chips: `bg-brand-orange/8 border-brand-orange/15 text-brand-orange/80` — warm, NOT green
- Allergen chips: `bg-white/5 border-white/12 text-brand-muted` — neutral, never green, never alarming
- Use `t('tag_X')` for dietary labels, `t('allergen_X')` for allergen labels, `t('trust_verified')` / `t('trust_inferred')` for trust badges
- Read translation from `item.name_translations[lang]` with fallback to `item.name_original`
- Read description from `item.description_translations?.[lang]` with fallback to `item.description_original`

**components/menu/AllergenBanner.tsx** (Locked decision):
- `'use client'`, imports `useLanguage`
- Single discreet banner: light amber/warm background (`bg-brand-orange/5 border-brand-orange/10`)
- Displays `t('allergen_disclaimer')` — localized per active language
- Light tone, not alarming — small text, subtle border
- No green anywhere — warm/neutral palette only
- Always visible at top of menu page (not conditional, not per-card)

**components/menu/LangSwitcher.tsx** (Pattern 8 from RESEARCH):
- `'use client'`, imports `useLanguage` and `SUPPORTED_LANGS` from `@/lib/i18n`
- Globe SVG icon button (inline SVG — a simple 24px globe outline)
- `useState<boolean>(false)` for dropdown open/close
- Click globe → toggle dropdown
- Dropdown: 4 language options, active language highlighted in `text-brand-orange`
- Clicking a language calls `setLang(l)` and closes dropdown
- Close dropdown on click outside (use `useEffect` with document click listener)
- Positioned absolute right-0, below the globe icon
- Dark background matching brand (`bg-brand-bg border-white/10 rounded-xl`)

**components/menu/FilterBar.tsx** (Pattern 5 from RESEARCH):
- `'use client'`, imports `useLanguage`
- Props: `{ filters: FilterState; onChange: (f: FilterState) => void }`
- Import `FilterState` from `@/hooks/useFilteredDishes`
- Import `DietaryTag`, `Allergen` from `@/lib/types/menu`
- Two filter groups:
  1. Dietary positives: `['vegetarian', 'vegan', 'spicy']` — use `t('filter_vegetarian')`, etc.
  2. Allergen exclusions: `['gluten', 'dairy', 'nuts', 'peanuts', 'eggs', 'fish', 'shellfish']` — 7 most common (Claude's discretion per RESEARCH recommendation). Use `t('filter_no_gluten')`, etc.
- Subtle vertical divider (`w-px bg-white/10`) between the two groups
- Sticky positioning: `sticky top-16 z-10 bg-brand-bg/90 backdrop-blur-sm border-b border-white/5`
- Horizontal scroll: `flex gap-2 overflow-x-auto no-scrollbar px-4 py-3`
- Active chip style: `bg-brand-orange/15 border-brand-orange/30 text-brand-orange`
- Inactive chip style: `bg-white/5 border-white/10 text-brand-muted`
- `toggleDietary(tag)` and `toggleAllergen(allergen)` functions that update filter state via `onChange`
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify all 4 files have `'use client'` directive. Verify DishCard uses `useLanguage()` for translations. Verify AllergenBanner renders `t('allergen_disclaimer')`. Verify FilterBar has 3 dietary + 7 allergen exclusion chips.
  </verify>
  <done>
4 components created: DishCard shows translated name/description/price with trust badge, dietary tags, and allergen chips (no green anywhere). AllergenBanner shows localized disclaimer. LangSwitcher has globe icon + 4-language dropdown. FilterBar has sticky horizontal chips for dietary + allergen exclusion filters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MenuShell coordinator and refactor /menu/[id]/page.tsx</name>
  <files>components/menu/MenuShell.tsx, components/menu/MenuAccordion.tsx, app/menu/[id]/page.tsx</files>
  <action>
Wire everything together through the MenuShell client coordinator.

**components/menu/MenuShell.tsx** (Pattern 4 from RESEARCH):
- `'use client'` directive
- Import `useState` from React
- Import `LanguageProvider`, `useLanguage` from `@/lib/i18n`
- Import `useFilteredDishes`, `FilterState` from `@/hooks/useFilteredDishes`
- Import `AnimatePresence`, `motion` from `'motion/react'`
- Import `MenuWithItems` from `@/lib/types/menu`
- Import all 4 components: AllergenBanner, FilterBar, DishCard, LangSwitcher
- Import `MenuAccordion` (for unfiltered accordion view)
- Props: `{ menu: MenuWithItems }`
- State: `filters: FilterState` (initialized with empty arrays)
- Compute: `filteredItems = useFilteredDishes(menu.menu_items, filters)`
- Compute: `hasActiveFilters = filters.dietaryTags.length > 0 || filters.excludeAllergens.length > 0`
- Inner component `MenuContent` (needs to be inside LanguageProvider to use `useLanguage`):
  - Uses `useLanguage()` for `t()` function
  - Renders:
    1. **Header section** with restaurant name (from `menu.restaurant_name`), source badge, dish count using `t('menu_header')`, and LangSwitcher (right-aligned)
    2. **AllergenBanner** — always visible below header
    3. **FilterBar** — sticky below nav
    4. **Conditional content**:
       - If `hasActiveFilters && filteredItems.length === 0`: Empty state with `t('empty_filters')` message + "Clear filters" button that resets `filters` to `{ dietaryTags: [], excludeAllergens: [] }`
       - If `hasActiveFilters && filteredItems.length > 0`: Flat animated list using `AnimatePresence` + `motion.div` (Pattern 7 from RESEARCH). Each item wrapped in `motion.div` with `key={item.id}`, `initial={{ opacity: 0, y: -4 }}`, `animate={{ opacity: 1, y: 0 }}`, `exit={{ opacity: 0, y: -4 }}`, `transition={{ duration: 0.15, ease: 'easeOut' }}`, `layout` prop
       - If no active filters: `<MenuAccordion items={menu.menu_items} />` (full accordion)
- Wrap everything in `<LanguageProvider>` at the top level

**components/menu/MenuAccordion.tsx** — Refactor existing:
- Add `'use client'` (already has it)
- Import `useLanguage` from `@/lib/i18n`
- Refactor the inner `DishCard` — REPLACE the existing inline DishCard with the new `DishCard` component from `@/components/menu/DishCard`
- Remove the old inline `DishCard` and `TrustBadge` functions from this file
- Keep `buildSections`, `ChevronDown`, `SubAccordion`, `SectionAccordion` structure unchanged
- In `SubAccordion` and `SectionAccordion`, replace `<DishCard key={item.id} item={item} />` usage — it should now use the imported DishCard
- Update the empty state message to use `t()` if possible, or keep hardcoded English (it's a fallback)

**app/menu/[id]/page.tsx** — Refactor:
- Keep as Server Component (no 'use client')
- Keep the `generateMetadata` function unchanged
- Remove the old `SourceBadge` component (MenuShell handles it)
- Remove the inline header, MenuAccordion usage, and footer
- Replace with: import `MenuShell` from `@/components/menu/MenuShell`, render `<MenuShell menu={typedMenu} />`
- Keep the `min-h-screen bg-brand-bg` wrapper and `max-w-xl mx-auto` container
- The page becomes a thin Server Component that fetches data and delegates to the client shell

The SourceBadge functionality should move into MenuShell's header area (keep the same styling: `inline-flex items-center px-3 py-1 rounded-full bg-white/5 border border-white/10 text-brand-muted text-xs font-medium`).
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` to verify the page builds. Verify page.tsx is a Server Component (no 'use client'). Verify MenuShell wraps content in LanguageProvider. Verify DishCard is imported (not defined inline) in MenuAccordion.
  </verify>
  <done>
MenuShell coordinates language + filter state. Page.tsx is a thin Server Component. Accordion shows for unfiltered view, flat animated list for filtered view. AllergenBanner always visible. LangSwitcher in header. FilterBar sticky below nav. Empty filter state has clear-filters button.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify dish cards, filters, language switching, and allergen display</name>
  <what-built>Complete dish card display surface with translations, trust badges, allergen chips, dietary tags, sticky filter bar, language switcher, and allergen disclaimer banner. All built on top of the existing /menu/[id] page.</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to a menu page: `http://localhost:3000/menu/{any-existing-menu-id}`
   (If no menu exists, scan a URL from `/scan` first to create one)

**Dish Cards (DISH-01, DISH-02, DISH-03, DISH-04, DISH-06):**
3. Verify each dish card shows:
   - Translated name (prominent, white text)
   - Original name below in smaller muted text (only if different from translation)
   - Translated description (if available)
   - Price (right-aligned, orange)
   - Trust badge: "Menu vérifié" or "Données inférées"
   - Allergen chips (neutral/warm colors — NO green)
   - Dietary tag chips (warm orange — NO green)

**Allergen Disclaimer (DISH-05):**
4. Verify a discreet banner appears at the TOP of the menu page with allergen disclaimer text
5. Verify the banner is light/warm toned, not alarming

**Language Switching (DISH-02):**
6. Click the globe icon in the header
7. Verify 4 language options appear (Français, English, Türkçe, Deutsch)
8. Select "English" — verify ALL dish names, descriptions, trust badges, and disclaimer switch to English
9. Select "Deutsch" — verify everything switches to German
10. Refresh the page — verify the language persists (localStorage)

**Filters (FILT-01, FILT-02, FILT-03, FILT-04):**
11. Verify sticky filter bar appears below the nav with dietary chips (Végétarien, Végan, Épicé) and allergen exclusion chips (Sans gluten, Sans lactose, etc.)
12. Tap "Végétarien" — verify non-vegetarian dishes disappear INSTANTLY (no spinner, no API call)
13. Verify filtered view is a flat list (not accordion sections)
14. Tap "Sans gluten" while "Végétarien" is still active — verify only vegetarian dishes without gluten remain (stacked filters)
15. If all dishes are filtered out, verify an empty state message appears with a "Clear filters" button
16. Tap "Clear filters" — verify all dishes return in accordion view

**Visual Check:**
17. Verify NO green color appears anywhere on allergen chips, dietary tags, or trust badges
18. Verify the overall look is mobile-friendly (test at 375px viewport width)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. /menu/[id] page renders dish cards with translations in the active language
4. Language switcher changes all translated content page-wide
5. Filter chips toggle instantly, stacking correctly
6. Allergen disclaimer banner always visible at top
7. No green color on any allergen/dietary/trust badge element
8. Filtered view uses flat animated list, unfiltered uses accordion
</verification>

<success_criteria>
- Each dish card shows translated name, description, price, trust badge, allergens, and dietary tags in the selected language
- Globe icon switches between FR/EN/TR/DE page-wide with localStorage persistence
- Filter chips apply instantly client-side with correct AND stacking
- Allergen disclaimer banner is always present, localized, and discreet
- No green color appears anywhere in allergen/dietary presentation
- Mobile-first layout works at 375px viewport
</success_criteria>

<output>
After completion, create `.planning/phases/06-dish-cards-and-filters/06-02-SUMMARY.md`
</output>
