---
phase: 04-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/schema.sql
  - lib/types/menu.ts
  - lib/types/llm.ts
  - lib/types/config.ts
  - lib/supabase-admin.ts
autonomous: true
requirements: [INFR-01]
user_setup:
  - service: supabase
    why: "Service role key needed for server-side writes (LLM results stored after cache miss)"
    env_vars:
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (secret)"

must_haves:
  truths:
    - "SQL schema creates menus, menu_items, and admin_config tables with correct columns and types"
    - "RLS policies allow public reads on menus/menu_items and restrict admin_config to service role only"
    - "TypeScript types mirror the database schema and Zod schema validates the LLM response shape"
    - "Service role Supabase client exists server-only and can write to tables bypassing RLS"
  artifacts:
    - path: "supabase/schema.sql"
      provides: "Complete SQL schema with tables, enums, indexes, RLS policies, and admin_config seed"
      contains: "create table menus"
    - path: "lib/types/menu.ts"
      provides: "Menu, MenuItem TypeScript types mirroring DB schema"
      contains: "MenuItem"
    - path: "lib/types/llm.ts"
      provides: "Zod schema for LLM structured output + inferred DishResponse type"
      contains: "dishResponseSchema"
    - path: "lib/types/config.ts"
      provides: "AdminConfig TypeScript type"
      contains: "AdminConfig"
    - path: "lib/supabase-admin.ts"
      provides: "Service role Supabase client for server-side writes"
      contains: "supabaseAdmin"
  key_links:
    - from: "lib/types/llm.ts"
      to: "lib/types/menu.ts"
      via: "Shared allergen enum values and translation map shape"
      pattern: "allergen|TranslationMap"
    - from: "lib/supabase-admin.ts"
      to: "process.env.SUPABASE_SERVICE_ROLE_KEY"
      via: "Server-only env var for write access"
      pattern: "SUPABASE_SERVICE_ROLE_KEY"
---

<objective>
Create the Supabase database schema (menus, menu_items, admin_config), TypeScript types, Zod validation schemas, and the service role Supabase client.

Purpose: Establish the data layer foundation that all downstream phases (Scan Pipeline, Dish Cards, Admin) build on. Without correct schema + types, nothing downstream can store or read data.

Output: SQL schema file ready to run, TypeScript types for all domain objects, Zod schema for LLM response validation, service role client for server writes.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-infrastructure-foundation/04-RESEARCH.md
@lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL schema and TypeScript types</name>
  <files>
    supabase/schema.sql
    lib/types/menu.ts
    lib/types/llm.ts
    lib/types/config.ts
  </files>
  <action>
Create `supabase/schema.sql` with the complete database schema. This file is the single source of truth for the DB structure — the user will run it manually in the Supabase SQL editor.

**SQL schema (exact specification from research):**

1. Create enum types:
   - `allergen_type` with all EU 14 values: gluten, dairy, nuts, peanuts, soy, eggs, fish, shellfish, celery, mustard, sesame, sulphites, lupin, molluscs
   - `trust_signal_type` with values: verified, inferred

2. Create `menus` table:
   - `id` uuid PK (gen_random_uuid)
   - `url` text NOT NULL
   - `url_hash` text NOT NULL UNIQUE (SHA-256 hex, 64 chars)
   - `restaurant_name` text (nullable)
   - `source_type` text (nullable — 'url' | 'photo' | 'qr')
   - `raw_text` text (nullable — original scraped/OCR text for debugging)
   - `parsed_at` timestamptz default now()
   - `expires_at` timestamptz NOT NULL (parsed_at + cache_ttl_hours)
   - `created_at` timestamptz default now()
   - Indexes: `idx_menus_url_hash` on (url_hash), `idx_menus_url_hash_expires` on (url_hash, expires_at)

3. Create `menu_items` table:
   - `id` uuid PK (gen_random_uuid)
   - `menu_id` uuid NOT NULL references menus(id) ON DELETE CASCADE
   - `name_original` text NOT NULL
   - `name_translations` jsonb NOT NULL — shape: {"fr":"...","en":"...","tr":"...","de":"..."}
   - `description_original` text (nullable)
   - `description_translations` jsonb (nullable) — same shape
   - `price` text (nullable — "12EUR" or null)
   - `allergens` allergen_type[] NOT NULL DEFAULT '{}'
   - `dietary_tags` text[] NOT NULL DEFAULT '{}' — use text[] not enum (list may grow, per research)
   - `trust_signal` trust_signal_type NOT NULL DEFAULT 'inferred'
   - `sort_order` integer NOT NULL DEFAULT 0 (preserves menu order)
   - `created_at` timestamptz default now()
   - Index: `idx_menu_items_menu_id` on (menu_id)

4. Create `admin_config` table (single-row pattern):
   - `id` boolean PK DEFAULT true CHECK (id = true) — enforces single row
   - `llm_model` text NOT NULL DEFAULT 'gpt-4o-mini'
   - `cache_ttl_hours` integer NOT NULL DEFAULT 168 (7 days)
   - `updated_at` timestamptz default now()
   - Seed row: INSERT with defaults

5. RLS policies:
   - `menus`: enable RLS, policy "Public can read menus" on SELECT to anon, authenticated using (true)
   - `menu_items`: enable RLS, policy "Public can read menu_items" on SELECT to anon, authenticated using (true)
   - `admin_config`: enable RLS, NO public policies (service role only — service role bypasses RLS entirely)

**TypeScript types:**

Create `lib/types/menu.ts`:
- `TranslationMap` type: `{ fr: string; en: string; tr: string; de: string }`
- `Allergen` type: union of EU 14 string literals
- `DietaryTag` type: `'vegetarian' | 'vegan' | 'halal'`
- `TrustSignal` type: `'verified' | 'inferred'`
- `Menu` interface mirroring menus table (id, url, url_hash, restaurant_name, source_type, raw_text, parsed_at, expires_at, created_at)
- `MenuItem` interface mirroring menu_items table (id, menu_id, name_original, name_translations, description_original, description_translations, price, allergens, dietary_tags, trust_signal, sort_order, created_at)
- `MenuWithItems` type: `Menu & { menu_items: MenuItem[] }`

Create `lib/types/llm.ts`:
- Import `z` from 'zod'
- `allergenEnum` Zod enum with all 14 values
- `translationMapSchema` Zod object with fr, en, tr, de as z.string()
- `dishResponseSchema` Zod object matching the locked LLM response shape:
  - name_original: z.string()
  - name_translations: translationMapSchema
  - description_original: z.string().nullable() — use .nullable() NOT .optional() (OpenAI structured outputs requirement per research pitfall #6)
  - description_translations: translationMapSchema.nullable()
  - price: z.string().nullable()
  - allergens: z.array(allergenEnum)
  - dietary_tags: z.array(z.enum(['vegetarian', 'vegan', 'halal']))
  - trust_signal: z.enum(['verified', 'inferred'])
- `menuResponseSchema` = z.object({ dishes: z.array(dishResponseSchema) })
- Export inferred types: `DishResponse`, `MenuResponse`

Create `lib/types/config.ts`:
- `AdminConfig` interface mirroring admin_config table (id, llm_model, cache_ttl_hours, updated_at)
- `DEFAULT_LLM_MODEL` constant = 'gpt-4o-mini'
- `DEFAULT_CACHE_TTL_HOURS` constant = 168
  </action>
  <verify>
- `cat supabase/schema.sql` contains CREATE TABLE for menus, menu_items, admin_config
- `npx tsc --noEmit lib/types/menu.ts lib/types/llm.ts lib/types/config.ts` compiles without errors (after deps installed in Plan 02)
- Zod schema in llm.ts uses .nullable() not .optional() for optional fields
  </verify>
  <done>
SQL schema file exists with all 3 tables, 2 enums, 4 indexes, 3 RLS policies, and 1 seed row. TypeScript types exist for Menu, MenuItem, DishResponse (Zod-inferred), and AdminConfig. All translation fields use the flat JSONB shape {fr, en, tr, de}.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create service role Supabase client</name>
  <files>
    lib/supabase-admin.ts
    .env.example
  </files>
  <action>
Create `lib/supabase-admin.ts` — a server-only Supabase client using the service_role key for write operations (inserting LLM parse results).

**Implementation:**
```typescript
import 'server-only';
import { createClient } from '@supabase/supabase-js';

export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  {
    auth: {
      persistSession: false,
      autoRefreshToken: false,
      detectSessionInUrl: false,
    },
  }
);
```

Key requirements:
- `import 'server-only'` at the top — prevents client bundle inclusion (build-time error if imported in Client Component)
- `SUPABASE_SERVICE_ROLE_KEY` with NO `NEXT_PUBLIC_` prefix — this key must never reach the browser
- Auth options disabled: `persistSession: false`, `autoRefreshToken: false`, `detectSessionInUrl: false` — service role client doesn't need session management
- Uses `process.env.NEXT_PUBLIC_SUPABASE_URL` (shared with anon client) for the URL

**Update `.env.example`** to add the new env vars needed for v1.1:
- Add `SUPABASE_SERVICE_ROLE_KEY=` (no NEXT_PUBLIC_ prefix)
- Add `OPENAI_API_KEY=` (for Phase 4 Plan 02)
- Keep existing `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`

Do NOT modify `.env.local` — the user will add the service role key themselves.
  </action>
  <verify>
- `grep "server-only" lib/supabase-admin.ts` confirms server-only guard is present
- `grep "NEXT_PUBLIC" lib/supabase-admin.ts` only shows the URL (not the key) — service role key must NOT be NEXT_PUBLIC_
- `.env.example` contains SUPABASE_SERVICE_ROLE_KEY and OPENAI_API_KEY entries
  </verify>
  <done>
Service role client exists at lib/supabase-admin.ts with server-only guard, no-session auth config, and non-public env var for the key. .env.example documents all required env vars for v1.1.
  </done>
</task>

</tasks>

<verification>
1. `supabase/schema.sql` is syntactically valid SQL (reviewer check — no Supabase CLI in project)
2. All TypeScript files in `lib/types/` export the expected types/schemas
3. `lib/supabase-admin.ts` uses `import 'server-only'` and `SUPABASE_SERVICE_ROLE_KEY` (not NEXT_PUBLIC_)
4. `.env.example` has all 4 env vars: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, OPENAI_API_KEY
</verification>

<success_criteria>
- SQL schema covers menus (with url_hash unique index), menu_items (with allergen enum array, JSONB translations), and admin_config (single-row pattern)
- TypeScript types mirror the database schema exactly
- Zod schema validates the LLM response shape with .nullable() (not .optional())
- Service role client is server-only with correct env var naming
</success_criteria>

<output>
After completion, create `.planning/phases/04-infrastructure-foundation/04-01-SUMMARY.md`
</output>
