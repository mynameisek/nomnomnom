---
phase: 03-waitlist-ship
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/actions/waitlist.ts
  - components/sections/FinalCta.tsx
autonomous: true
requirements:
  - WAIT-01
  - WAIT-02
  - WAIT-03
  - WAIT-04
  - WAIT-05
  - WAIT-06

must_haves:
  truths:
    - "User can enter email and submit with 'C'est parti' button"
    - "After signup, user sees 'Parfait ! On te prévient dès que c'est prêt.' message"
    - "Email is stored in Supabase waitlist table"
    - "After signup, user sees a unique referral link they can copy"
    - "User sees their waitlist position and number of friends referred"
    - "Duplicate email shows 'Tu es déjà inscrit(e) !' with existing referral dashboard"
    - "Visiting with ?ref=CODE and signing up credits the referrer"
  artifacts:
    - path: "app/actions/waitlist.ts"
      provides: "Server Action for waitlist signup, validation, referral logic, dashboard data"
      exports: ["joinWaitlist", "WaitlistState"]
    - path: "components/sections/FinalCta.tsx"
      provides: "Email form with useActionState, inline referral dashboard after success"
      min_lines: 80
  key_links:
    - from: "components/sections/FinalCta.tsx"
      to: "app/actions/waitlist.ts"
      via: "useActionState(joinWaitlist, initialState)"
      pattern: "useActionState.*joinWaitlist"
    - from: "app/actions/waitlist.ts"
      to: "lib/supabase.ts"
      via: "supabase.from('waitlist').insert/select"
      pattern: "supabase\\.from\\(['\"]waitlist['\"]\\)"
---

<objective>
Wire the Supabase waitlist backend and transform the static FinalCta placeholder into a working email signup form with referral system and inline dashboard.

Purpose: This is the core conversion mechanism — users enter their email, join the waitlist, get a referral link, and can track their position and referrals.
Output: Working Server Action (`app/actions/waitlist.ts`) + interactive FinalCta component with form, success state, duplicate handling, and referral dashboard.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-waitlist-ship/03-RESEARCH.md
@components/sections/FinalCta.tsx
@lib/supabase.ts
@lib/data.ts
@components/ui/Btn.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase waitlist table and Server Action</name>
  <files>app/actions/waitlist.ts</files>
  <action>
**IMPORTANT: Before writing code, create the Supabase table.** Run the following SQL via the Supabase Management API or instruct the user. The SQL to execute in Supabase SQL editor:

```sql
CREATE TABLE public.waitlist (
  id          UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email       TEXT UNIQUE NOT NULL,
  ref_code    TEXT UNIQUE NOT NULL,
  referrer_code TEXT,
  created_at  TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

ALTER TABLE public.waitlist ENABLE ROW LEVEL SECURITY;

CREATE POLICY "anon_can_insert" ON public.waitlist
  FOR INSERT TO anon WITH CHECK (true);

CREATE POLICY "anon_can_select" ON public.waitlist
  FOR SELECT TO anon USING (true);

CREATE INDEX waitlist_referrer_code_idx ON public.waitlist (referrer_code);
CREATE INDEX waitlist_created_at_idx ON public.waitlist (created_at);
```

**Create a checkpoint:human-action to have the user run this SQL in the Supabase dashboard SQL editor** before proceeding. Then:

Create `app/actions/waitlist.ts` with `'use server'` directive:

1. **Types:** Export `WaitlistState` union type with `idle | success | duplicate | error` status variants. Success and duplicate both carry `refCode: string`, `position: number`, `referralCount: number`.

2. **Constants:** `REFERRAL_BONUS_SPOTS = 5` (each referral moves user up 5 spots).

3. **`generateRefCode()`:** Uses `Math.random().toString(36).slice(2, 8).toUpperCase()` — 6-char alphanumeric.

4. **`isValidEmail(email: string)`:** Regex `/^[^\s@]+@[^\s@]+\.[^\s@]+$/` and `email.length < 255`.

5. **`joinWaitlist(prevState: WaitlistState, formData: FormData)`:** The Server Action.
   - Extract `email` (trimmed, lowercased) and `ref` (hidden field, the referrer code from URL) from formData.
   - Validate email — return `{ status: 'error', message: 'Adresse email invalide.' }` on failure.
   - Check for existing signup: `supabase.from('waitlist').select('ref_code, created_at').eq('email', email).maybeSingle()`.
   - If existing: call `getDashboard(existing.ref_code)` and return `{ status: 'duplicate', ...dashboard }`.
   - If new: generate `refCode`, insert `{ email, ref_code: refCode, referrer_code: ref || null }`.
   - Handle insert error code `23505` (race condition duplicate) — fetch existing row and return duplicate status.
   - On other errors: return `{ status: 'error', message: 'Erreur réseau. Réessaie dans quelques secondes.' }`.
   - On success: call `getDashboard(refCode)` and return `{ status: 'success', ...dashboard }`.

6. **`getDashboard(refCode: string)`:** Helper returning `{ refCode, position, referralCount }`.
   - Get user's row: `supabase.from('waitlist').select('created_at').eq('ref_code', refCode).single()`.
   - Count rows with `created_at <= user.created_at` for raw position.
   - Count rows with `referrer_code = refCode` for referral count.
   - `position = Math.max(1, rawPosition - (referralCount * REFERRAL_BONUS_SPOTS))`.

Import `supabase` from `@/lib/supabase`.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors in app/actions/waitlist.ts. Verify the file exports `joinWaitlist` and `WaitlistState`.</verify>
  <done>Server Action file exists with correct signature `(prevState: WaitlistState, formData: FormData) => Promise<WaitlistState>`, handles insert/duplicate/error/dashboard, uses Supabase client.</done>
</task>

<task type="auto">
  <name>Task 2: Replace FinalCta static button with working waitlist form and referral dashboard</name>
  <files>components/sections/FinalCta.tsx</files>
  <action>
Convert `FinalCta.tsx` from a Server Component to a `'use client'` component with `useActionState`.

**Form state management:**
- `import { useActionState } from 'react'`
- `import { joinWaitlist, type WaitlistState } from '@/app/actions/waitlist'`
- `const [state, formAction, pending] = useActionState(joinWaitlist, { status: 'idle' as const })`

**Reading ?ref= param:**
- Use `useSearchParams()` from `next/navigation` inside a `<Suspense>` boundary to read `ref` param.
- Alternatively, create a small inner component `WaitlistForm` wrapped in `<Suspense fallback={null}>` that uses `useSearchParams()`.
- Pass the `ref` value as a hidden input `<input type="hidden" name="ref" value={ref} />`.

**Replace the static `<Btn>` in the waitlist section** (first section, the one with food collage background):

When `state.status === 'idle' || state.status === 'error'`:
- Show `<form action={formAction}>` with:
  - `<input type="email" name="email" required placeholder="ton@email.com" />` — styled with dark bg, rounded, matching brand tokens. Inline validation error below if `state.status === 'error'`.
  - Hidden `ref` input.
  - `<button type="submit" disabled={pending}>` showing "Inscription..." when pending, "C'est parti" when idle.
  - If `state.status === 'error'`: show `<p role="alert" className="text-brand-red text-sm">{state.message}</p>`.

When `state.status === 'success'`:
- Show success message: "Parfait ! On te prévient dès que c'est prêt." in green text.
- Show inline referral dashboard (see below).

When `state.status === 'duplicate'`:
- Show: "Tu es déjà inscrit(e) !" in orange text.
- Show same inline referral dashboard.

**Referral dashboard (shown after success or duplicate):**
- Display 3 items in a row (flex-wrap for mobile):
  1. **Position:** "Ta position: #{state.position}" — bold number.
  2. **Referrals:** "{state.referralCount} ami(s) parrainé(s)" — with small icon or emoji.
  3. **Share link:** Input showing the referral URL `${window.location.origin}?ref=${state.refCode}` with a "Copier" button next to it.
- Copy button uses `navigator.clipboard.writeText(url)` with try/catch. On success, button text changes to "Copié !" for 2 seconds.

**Keep the second section (Final CTA "Plus jamais hesiter") unchanged** — it still has the anchor link `<Btn primary big href="#waitlist">`.

**Styling notes:**
- Email input: `bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder:text-white/30 focus:outline-none focus:ring-2 focus:ring-brand-orange/50`
- Submit button: reuse brand-orange styling from Btn component but as a native `<button>`.
- Dashboard: `bg-white/5 rounded-2xl p-6 mt-4` container, items in a flex row with gap.
- Referral URL input: `bg-white/10 rounded-lg px-3 py-2 text-sm text-white/70 flex-1` with copy button next to it.
- Use motion/react `AnimatePresence` and `motion.div` for smooth transitions between form and dashboard states (fade in/out with opacity + y offset).
  </action>
  <verify>Run `npm run build` — no build errors. Run dev server and verify: (1) email input and button visible in waitlist section, (2) submitting with valid email triggers Server Action (check network tab), (3) component renders without hydration errors.</verify>
  <done>FinalCta shows email form with "C'est parti" button; on submit, Server Action fires; success shows "Parfait !" message + referral dashboard with position, referral count, and copy-able share link; duplicate shows "Tu es déjà inscrit(e) !" + dashboard; errors show inline message.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Manual test: enter email on the waitlist form → see success message + referral dashboard
4. Manual test: enter same email again → see "Tu es déjà inscrit(e) !" + same dashboard
5. Manual test: visit `?ref=SOMECODE`, sign up with new email → Supabase row has referrer_code set
6. Referral dashboard shows position and referral count
7. Copy button copies referral URL to clipboard
</verification>

<success_criteria>
- Email form replaces static button in FinalCta waitlist section
- Emails are stored in Supabase `waitlist` table with unique ref_code
- Success state shows exact message "Parfait ! On te prévient dès que c'est prêt."
- Duplicate email shows "Tu es déjà inscrit(e) !" with existing dashboard
- Referral link is displayed and copyable after signup
- Position and referral count are shown in inline dashboard
- ?ref= parameter is captured and stored as referrer_code
</success_criteria>

<output>
After completion, create `.planning/phases/03-waitlist-ship/03-01-SUMMARY.md`
</output>
