---
phase: 07-navigation-and-admin
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - lib/admin-session.ts
  - app/api/admin/login/route.ts
  - app/admin/page.tsx
  - components/admin/AdminLogin.tsx
  - components/admin/AdminDashboard.tsx
  - app/actions/admin.ts
  - .env.example
autonomous: false
requirements:
  - ADMN-01
  - ADMN-02
  - ADMN-03

must_haves:
  truths:
    - "Visiting /admin without the correct secret shows a password input — the page is not accessible publicly"
    - "Entering the correct ADMIN_SECRET sets a session cookie and reveals the admin dashboard"
    - "Admin can switch the active LLM model from a dropdown and see a success indicator"
    - "Admin dashboard shows total scans, cached vs fresh ratio, and average parse time from live data"
    - "Recent scans list shows last 20 entries with URL and timestamp"
  artifacts:
    - path: "lib/admin-session.ts"
      provides: "Server-only cookie-based admin authentication"
      contains: "isAdminAuthenticated"
    - path: "app/api/admin/login/route.ts"
      provides: "POST endpoint that validates password and sets session cookie"
      contains: "POST"
    - path: "app/admin/page.tsx"
      provides: "Server Component that gates access — renders login or dashboard"
      contains: "isAdminAuthenticated"
    - path: "components/admin/AdminLogin.tsx"
      provides: "Password input form with inline error"
      contains: "password"
    - path: "components/admin/AdminDashboard.tsx"
      provides: "Model selector + stats display + recent scans"
      contains: "get_scan_stats"
    - path: "app/actions/admin.ts"
      provides: "Server Action to save model selection"
      contains: "saveAdminModel"
  key_links:
    - from: "app/admin/page.tsx"
      to: "lib/admin-session.ts"
      via: "isAdminAuthenticated() check before rendering dashboard"
      pattern: "isAdminAuthenticated"
    - from: "app/api/admin/login/route.ts"
      to: "lib/admin-session.ts"
      via: "setAdminCookie() on correct password"
      pattern: "setAdminCookie"
    - from: "components/admin/AdminDashboard.tsx"
      to: "app/actions/admin.ts"
      via: "Server Action call on model save"
      pattern: "saveAdminModel"
    - from: "app/actions/admin.ts"
      to: "admin_config"
      via: "supabaseAdmin update of llm_model"
      pattern: "admin_config.*update"
---

<objective>
Build the protected admin page with password-based auth, LLM model selector, and scan statistics dashboard.

Purpose: ADMN-01 (admin access), ADMN-02 (model selection), ADMN-03 (scan stats). This is the operational tooling for a solo-founder — functional, minimal, internal.
Output: Working /admin page with cookie-based auth, model dropdown with save, and live scan statistics.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-navigation-and-admin/07-RESEARCH.md
@.planning/phases/07-navigation-and-admin/07-01-SUMMARY.md
@lib/cache.ts
@lib/supabase-admin.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin session library + login Route Handler + admin page gate</name>
  <files>
    lib/admin-session.ts
    app/api/admin/login/route.ts
    app/admin/page.tsx
    components/admin/AdminLogin.tsx
    .env.example
  </files>
  <action>
**lib/admin-session.ts — server-only session utilities:**
- `import 'server-only'`
- `import { cookies } from 'next/headers'`
- `import { createHash } from 'node:crypto'`
- Constants: `COOKIE_NAME = 'admin_session'`, `COOKIE_MAX_AGE = 60 * 60 * 8` (8 hours per discretion)
- `getExpectedToken()`: returns `createHash('sha256').update(process.env.ADMIN_SECRET ?? '').digest('hex')` — derived token, not raw secret
- `isAdminAuthenticated()`: `async`, awaits `cookies()`, gets `COOKIE_NAME`, returns `session.value === getExpectedToken()`. Returns `false` if no ADMIN_SECRET env var or no cookie.
- `setAdminCookie()`: `async`, awaits `cookies()`, sets cookie with value=getExpectedToken(), httpOnly, secure in production, sameSite 'lax', path '/', maxAge COOKIE_MAX_AGE
- `clearAdminCookie()`: `async`, deletes the cookie

**app/api/admin/login/route.ts — POST login endpoint:**
- Import `NextRequest, NextResponse` from `next/server`
- Import `setAdminCookie` from `@/lib/admin-session`
- `export async function POST(req: NextRequest)`:
  - Parse `{ password }` from `req.json()`
  - Compare with `process.env.ADMIN_SECRET` — if missing or mismatch, return 401 JSON `{ error: 'Invalid password' }`
  - Use constant-time comparison is ideal but for a solo-admin tool, direct comparison is acceptable (per discretion)
  - On match: call `await setAdminCookie()`, return 200 JSON `{ ok: true }`

**app/admin/page.tsx — Server Component gate:**
- Import `isAdminAuthenticated` from `@/lib/admin-session`
- Import `AdminLogin` and `AdminDashboard` (client components)
- If not authenticated: render `<AdminLogin />`
- If authenticated: fetch current admin config via `getAdminConfig()` from `@/lib/cache`, fetch stats via `supabaseAdmin.rpc('get_scan_stats')`, fetch recent scans via `supabaseAdmin.from('menus').select('id, url, source_type, parsed_at, parse_time_ms').order('parsed_at', { ascending: false }).limit(20)`
- Pass `{ currentModel, stats, recentScans }` as props to `<AdminDashboard />`
- Set `export const dynamic = 'force-dynamic'` — admin page should never be cached
- Add `export const metadata = { title: 'Admin | NOM' }`

**components/admin/AdminLogin.tsx — login form:**
- `'use client'`
- Simple centered form: password input + submit button
- State: `password`, `error`, `loading`
- On submit: POST to `/api/admin/login` with `{ password }`
- On 401: show inline error "Mot de passe incorrect" below the input (per user decision: inline error, no redirect)
- On success: `window.location.reload()` to re-render the Server Component which now reads the cookie
- Styling: dark theme matching the app (bg-brand-bg, text-brand-white, orange accent), clean and minimal
- No visible URL bar secret — password input type="password"

**.env.example — add ADMIN_SECRET:**
- Add `ADMIN_SECRET=your-admin-secret-here` with a comment explaining it

  </action>
  <verify>
Run `npx next build` — must compile without errors. Verify lib/admin-session.ts exports isAdminAuthenticated, setAdminCookie, clearAdminCookie. Verify app/api/admin/login/route.ts exports POST. Verify app/admin/page.tsx imports and uses isAdminAuthenticated. Verify AdminLogin.tsx has password input and fetch to /api/admin/login.
  </verify>
  <done>
Visiting /admin without a session cookie shows a password form. Entering the wrong password shows an inline error. Entering the correct ADMIN_SECRET sets a cookie and reloads to show the dashboard. The session persists for 8 hours (no re-entry on page reload).
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin dashboard — model selector + stats + recent scans</name>
  <files>
    components/admin/AdminDashboard.tsx
    app/actions/admin.ts
  </files>
  <action>
**app/actions/admin.ts — Server Action for model save:**
- `'use server'`
- `import 'server-only'`
- Import `supabaseAdmin` from `@/lib/supabase-admin`, `isAdminAuthenticated` from `@/lib/admin-session`
- Import `revalidatePath` from `next/cache`
- `ALLOWED_MODELS = ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1-mini'] as const`
- `export async function saveAdminModel(model: string)`:
  - Check `isAdminAuthenticated()` — return `{ error: 'Unauthorized' }` if false
  - Validate model is in ALLOWED_MODELS — return `{ error: 'Invalid model' }` if not
  - `supabaseAdmin.from('admin_config').update({ llm_model: model, updated_at: new Date().toISOString() }).eq('id', true)`
  - On error: return `{ error: error.message }`
  - On success: call `revalidatePath('/admin')` to bust the cached Server Component (per research pitfall #6)
  - Return `{ ok: true, model }`
- Export `ALLOWED_MODELS` so the dashboard can use it for the dropdown options

**components/admin/AdminDashboard.tsx — dashboard UI:**
- `'use client'`
- Props: `{ currentModel: string, stats: { total_scans: number, active_cache_count: number, avg_parse_time_ms: number | null, total_cache_hits: number }, recentScans: Array<{ id: string, url: string, source_type: string, parsed_at: string, parse_time_ms: number | null }> }`

**Layout (per user decision: single-page, model selector at top, stats below):**

1. **Model Selector section (top):**
   - Label: "Modèle LLM actif"
   - Show current model prominently (per user decision: show current active model clearly)
   - `<select>` dropdown with the 3 options from ALLOWED_MODELS
   - "Enregistrer" save button (per user decision: save button pattern, explicit confirmation)
   - State: `selectedModel` (initialized to currentModel), `saving`, `saved`
   - On save: call `saveAdminModel(selectedModel)` Server Action
   - On success: show a green "Modèle mis à jour" toast/indicator for 3 seconds (per user decision: success toast/indicator)
   - On error: show red error message inline
   - Disable save button when selectedModel === currentModel (no change) or while saving

2. **Stats section (below model selector):**
   - Three stat cards in a row (grid cols-3 on desktop, cols-1 on mobile):
     - "Scans totaux": `stats.total_scans`
     - "Ratio cache": `${stats.active_cache_count} / ${stats.total_scans}` active cache entries vs total (show as fraction + percentage). Also show `stats.total_cache_hits` as "hits" label.
     - "Temps de parse moyen": `stats.avg_parse_time_ms ? ${stats.avg_parse_time_ms}ms : 'N/A'` (may be null if no fresh parses yet)
   - Simple number display with label — this is an internal tool, not fancy dashboards

3. **Recent Scans section (below stats):**
   - Label: "Derniers scans" with count "(20 derniers)"
   - Table or list: URL (truncated), source_type badge, parsed_at as relative time, parse_time_ms
   - Per user decision: last 10-20 with URL/timestamp — useful for debugging

**Styling:**
- Dark theme consistent with the app: bg-brand-bg / bg-zinc-900 cards, text-brand-white
- Orange accent for active elements (brand-orange)
- Clean and minimal (per user decision: internal tool, not user-facing polish)
- Responsive: stacked on mobile, grid on desktop
  </action>
  <verify>
Run `npx next build` — must compile without errors. Verify AdminDashboard.tsx renders model dropdown, 3 stat cards, and recent scans list. Verify app/actions/admin.ts exports saveAdminModel with auth check and revalidatePath. Verify the save action validates against ALLOWED_MODELS.
  </verify>
  <done>
Admin dashboard shows the current LLM model in a dropdown. Save button updates admin_config and shows a success indicator. Three stat cards display total scans, cache ratio, and avg parse time. Recent scans list shows the last 20 entries with URL/timestamp/parse time.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify admin page end-to-end</name>
  <files>app/admin/page.tsx</files>
  <action>
    Human verification of the complete admin page and navigation integration. No code changes — verify the following:
    1. Landing CTA navigates to /scan (client-side, no full reload, fade animation)
    2. /admin shows password form when unauthenticated
    3. Wrong password shows inline error
    4. Correct ADMIN_SECRET grants access to dashboard
    5. Model selector saves and shows success indicator
    6. Stats section shows live data
    7. Session persists on page refresh
  </action>
  <verify>
    1. Start dev server: `npm run dev`
    2. Visit http://localhost:3000 — click "Scanner un menu" CTA → navigates to /scan without full reload, fade-in animation
    3. Visit http://localhost:3000/admin → see password input, NOT the dashboard
    4. Enter wrong password → inline error "Mot de passe incorrect"
    5. Enter correct ADMIN_SECRET → dashboard with model selector and stats
    6. Change model → click "Enregistrer" → success indicator
    7. Refresh /admin → still authenticated, model shows updated value
  </verify>
  <done>All 4 success criteria from Phase 7 roadmap confirmed working: CTA navigation, admin access control, model switching, scan statistics display.</done>
</task>

</tasks>

<verification>
1. `npx next build` compiles without errors
2. /admin without session shows password input (ADMN-01)
3. Correct password sets cookie and shows dashboard (ADMN-01)
4. Model dropdown shows 3 options, save updates admin_config (ADMN-02)
5. Stats section shows total scans, cache ratio, avg parse time (ADMN-03)
6. Recent scans list shows last 20 entries (ADMN-03)
7. revalidatePath('/admin') ensures fresh data after model save
</verification>

<success_criteria>
- /admin is inaccessible without the correct password
- Admin can switch LLM model with confirmation feedback
- Dashboard shows 3 live stats from Supabase
- Recent scans list aids debugging
- All success criteria from phase 7 roadmap are met
</success_criteria>

<output>
After completion, create `.planning/phases/07-navigation-and-admin/07-02-SUMMARY.md`
</output>
