---
phase: 07-navigation-and-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ui/Btn.tsx
  - components/sections/Hero.tsx
  - components/scan/ScanPageShell.tsx
  - app/scan/page.tsx
  - supabase/schema.sql
  - supabase/migration-07-stats.sql
  - lib/cache.ts
autonomous: true
requirements:
  - INFR-05

must_haves:
  truths:
    - "Clicking the Hero CTA on the landing page navigates to /scan without a full page reload"
    - "The /scan page has a subtle fade-in animation on entry"
    - "The menus table has a parse_time_ms column and a get_scan_stats() RPC function ready for admin"
    - "getOrParseMenu records parse_time_ms for every fresh parse"
  artifacts:
    - path: "components/ui/Btn.tsx"
      provides: "next/link integration for internal hrefs"
      contains: "next/link"
    - path: "components/scan/ScanPageShell.tsx"
      provides: "Motion wrapper for scan page entry animation"
      contains: "motion"
    - path: "supabase/migration-07-stats.sql"
      provides: "parse_time_ms column + hit_count column + get_scan_stats RPC"
      contains: "parse_time_ms"
    - path: "lib/cache.ts"
      provides: "Timing instrumentation in getOrParseMenu"
      contains: "parse_time_ms"
  key_links:
    - from: "components/ui/Btn.tsx"
      to: "next/link"
      via: "Link component for internal hrefs starting with /"
      pattern: "href\\.startsWith\\('/'\\)"
    - from: "components/sections/Hero.tsx"
      to: "/scan"
      via: "Btn href=/scan using next/link under the hood"
      pattern: "href=\"/scan\""
    - from: "app/scan/page.tsx"
      to: "components/scan/ScanPageShell.tsx"
      via: "Server Component wraps children in ScanPageShell client component"
      pattern: "ScanPageShell"
---

<objective>
Wire the landing page CTA to /scan with client-side navigation and a fade-in animation, plus prepare the database schema and cache instrumentation for scan statistics.

Purpose: INFR-05 (navigation integration) is the user-facing deliverable. The schema migration and timing instrumentation are backend prep required by ADMN-03 (plan 07-02 depends on the parse_time_ms column and get_scan_stats RPC function).
Output: Working landing → /scan navigation with animation, SQL migration file, instrumented cache layer.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-navigation-and-admin/07-RESEARCH.md
@components/ui/Btn.tsx
@components/sections/Hero.tsx
@app/scan/page.tsx
@lib/cache.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Btn next/link integration + Hero CTA + ScanPageShell animation</name>
  <files>
    components/ui/Btn.tsx
    components/sections/Hero.tsx
    components/scan/ScanPageShell.tsx
    app/scan/page.tsx
  </files>
  <action>
**Btn.tsx — add next/link for internal routes:**
- Import `Link` from `next/link`
- In the anchor branch (when `href` exists), detect internal hrefs: `const isInternal = href.startsWith('/');`
- If internal: render `<Link href={href} className={baseClasses} {...anchorProps}>{children}</Link>`
- If external or hash anchor: keep existing `<a href={href}>` behavior
- This is a non-breaking change — all existing `#waitlist`, `#features` anchors continue using `<a>`

**Hero.tsx — update primary CTA:**
- Change the primary CTA from `<Btn primary big href="#waitlist">Rejoindre la liste d'attente</Btn>` to `<Btn primary big href="/scan">Scanner un menu</Btn>`
- Keep the secondary CTA (`href="#features"`) unchanged
- Per user decision: "Scanner un menu" or similar action-oriented text — use exactly "Scanner un menu"

**ScanPageShell.tsx — create thin client wrapper for entry animation:**
- New file at `components/scan/ScanPageShell.tsx`
- `'use client'` directive
- Import `{ motion }` from `'motion/react'`
- Accept `{ children: React.ReactNode }` props
- Return `<motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3, ease: 'easeOut' }}>{children}</motion.div>`
- Per user decision: subtle fade/slide transition — the y: 10 → 0 gives the "entering the app" feel
- Discretion: using motion/react (already installed at v12.34.3, consistent with FinalCta/Faq/Social patterns)

**app/scan/page.tsx — wrap content in ScanPageShell:**
- Import `ScanPageShell` from `@/components/scan/ScanPageShell`
- Wrap the outer `<div>` content inside `<ScanPageShell>` — keeps page.tsx as Server Component
- The ScanPageShell provides the client-side motion animation
  </action>
  <verify>
Run `npx next build` — must compile without errors. Verify Btn.tsx uses Link for internal hrefs by checking the import. Verify Hero.tsx has `href="/scan"`. Verify ScanPageShell.tsx exists with motion.div.
  </verify>
  <done>
Clicking "Scanner un menu" on the landing page navigates to /scan via client-side routing (no full reload). The /scan page fades in with a subtle slide animation. All existing anchor links (#waitlist, #features) still work as before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Schema migration + cache timing instrumentation</name>
  <files>
    supabase/migration-07-stats.sql
    supabase/schema.sql
    lib/cache.ts
  </files>
  <action>
**supabase/migration-07-stats.sql — create migration file:**
```sql
-- Phase 7: Add parse_time_ms and hit_count for scan statistics (ADMN-03)

-- parse_time_ms: milliseconds taken by LLM parse (populated on fresh parse only)
ALTER TABLE menus ADD COLUMN IF NOT EXISTS parse_time_ms integer;

-- hit_count: incremented each time a cache hit occurs (starts at 0)
ALTER TABLE menus ADD COLUMN IF NOT EXISTS hit_count integer NOT NULL DEFAULT 0;

-- Postgres function for admin dashboard stats (called via supabaseAdmin.rpc)
CREATE OR REPLACE FUNCTION get_scan_stats()
RETURNS json LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  RETURN (
    SELECT json_build_object(
      'total_scans', count(*),
      'active_cache_count', count(*) FILTER (WHERE expires_at > now()),
      'avg_parse_time_ms', round(avg(parse_time_ms)::numeric, 0),
      'total_cache_hits', coalesce(sum(hit_count), 0)
    )
    FROM menus
  );
END;
$$;
```

**supabase/schema.sql — update canonical schema (add columns to menus table):**
- Add `parse_time_ms integer,` after the `raw_text` column
- Add `hit_count integer not null default 0,` after `parse_time_ms`
- This keeps schema.sql as the single source of truth for the full schema

**lib/cache.ts — instrument getOrParseMenu:**
1. On cache HIT: increment `hit_count` via `supabaseAdmin.from('menus').update({ hit_count: (cached.hit_count ?? 0) + 1 }).eq('id', cached.id)` — fire-and-forget (no await needed, don't block the response)
2. On cache MISS (fresh parse): wrap the LLM call in timing:
   - `const parseStart = Date.now();`
   - `const parsed = preParseResult ?? await parseDishesFromMenu(rawText, config.llm_model);`
   - `const parseTimeMs = preParseResult ? null : Date.now() - parseStart;`
   - (If preParseResult was provided, parse_time_ms is null since no LLM call happened here)
3. Include `parse_time_ms: parseTimeMs` in the menus insert object
4. Import type for hit_count — the MenuWithItems type should handle the new columns gracefully (they're nullable/defaulted)
  </action>
  <verify>
Run `npx next build` — must compile without errors. Verify migration-07-stats.sql has the ALTER TABLE and CREATE FUNCTION statements. Verify lib/cache.ts has `parse_time_ms` in the insert and `hit_count` increment on cache hit.
  </verify>
  <done>
The SQL migration adds parse_time_ms, hit_count, and get_scan_stats() to the database. getOrParseMenu records LLM parse duration on fresh parses and increments hit_count on cache hits. The admin dashboard (plan 07-02) can now call supabaseAdmin.rpc('get_scan_stats') for all 3 required stats.
  </done>
</task>

</tasks>

<verification>
1. `npx next build` compiles without errors
2. Btn.tsx imports `Link` from `next/link` and uses it for hrefs starting with `/`
3. Hero.tsx primary CTA has `href="/scan"` with text "Scanner un menu"
4. ScanPageShell.tsx exists with `'use client'` and motion.div fade animation
5. app/scan/page.tsx wraps content in ScanPageShell
6. supabase/migration-07-stats.sql contains ALTER TABLE + CREATE FUNCTION
7. lib/cache.ts records parse_time_ms on insert and increments hit_count on cache hit
</verification>

<success_criteria>
- Landing page CTA navigates to /scan with client-side routing (no full page reload)
- /scan page shows a subtle fade/slide entry animation
- Database migration file is ready to run for parse statistics
- Cache layer instruments timing and hit counts for admin dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/07-navigation-and-admin/07-01-SUMMARY.md`
</output>
