---
phase: 12-dish-images
plan: "02"
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - components/menu/DishImage.tsx
  - components/menu/DishImageFallback.tsx
  - components/menu/DishCard.tsx
  - components/menu/DishDetailSheet.tsx
  - components/menu/MenuShell.tsx
  - hooks/useEnrichmentPolling.ts
  - lib/dish-fallback.ts
autonomous: false
requirements: [ENRI-05]

must_haves:
  truths:
    - "A DishCard for a full-depth enriched dish with image_url displays a square photo with blur-up loading"
    - "A DishCard for a full-depth dish without image_url displays a cuisine-based gradient with emoji"
    - "Tapping the image opens the DishDetailSheet (same behavior as tapping enrichment row)"
    - "The DishDetailSheet displays a larger image at top and photo credit with link at bottom"
    - "The polling hook continues polling until full-depth items have image_url (or stops after existing timeout)"
    - "No broken images appear ‚Äî fallback is always rendered when image_url is null"
  artifacts:
    - path: "components/menu/DishImage.tsx"
      provides: "Square image component with next/image, blur-up, and aspect-square container"
      min_lines: 15
    - path: "components/menu/DishImageFallback.tsx"
      provides: "Gradient+emoji fallback component for dishes without stock photos"
      min_lines: 15
    - path: "lib/dish-fallback.ts"
      provides: "Cuisine gradient map + emoji lookup"
      exports: ["getCuisineGradient", "getDishEmoji"]
  key_links:
    - from: "components/menu/DishCard.tsx"
      to: "components/menu/DishImage.tsx"
      via: "Renders DishImage when item.image_url exists"
      pattern: "DishImage"
    - from: "components/menu/DishCard.tsx"
      to: "components/menu/DishImageFallback.tsx"
      via: "Renders DishImageFallback when item.image_url is null for full-depth items"
      pattern: "DishImageFallback"
    - from: "components/menu/DishDetailSheet.tsx"
      to: "next/image"
      via: "Renders larger image + attribution credit link"
      pattern: "image_credit"
    - from: "hooks/useEnrichmentPolling.ts"
      to: "app/api/enrichment/status"
      via: "Polling response now includes image fields merged into items"
      pattern: "image_url"
---

<objective>
Add dish image display to DishCard and DishDetailSheet: square photo with blur-up loading, cuisine-based gradient+emoji fallback, and photographer attribution in the detail sheet.

Purpose: Each enriched dish card visually represents its dish with a licensed photo or an intentional gradient fallback ‚Äî making the menu browsing experience richer and more appetizing.
Output: DishImage component, DishImageFallback component, updated DishCard/DishDetailSheet, polling hook extension.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dish-images/12-RESEARCH.md
@.planning/phases/12-dish-images/12-01-SUMMARY.md
@components/menu/DishCard.tsx
@components/menu/DishDetailSheet.tsx
@components/menu/MenuShell.tsx
@hooks/useEnrichmentPolling.ts
@lib/types/menu.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DishImage + DishImageFallback + fallback data + DishCard integration</name>
  <files>
    components/menu/DishImage.tsx
    components/menu/DishImageFallback.tsx
    lib/dish-fallback.ts
    components/menu/DishCard.tsx
  </files>
  <action>
1. **`lib/dish-fallback.ts`** ‚Äî cuisine gradient map and emoji lookup (plain TS, no directive):
   - `CUISINE_GRADIENTS: Record<string, [string, string]>` mapping origin keywords to [fromColor, toColor] pairs:
     - Turkish keywords (turquie, ankara, anatolie, istanbul): warm reds `['#C84B31', '#E07B39']`
     - Vietnamese (vietnam): greens `['#2D6A4F', '#52B788']`
     - Japanese (japon): red/navy `['#E63946', '#1D3557']`
     - Chinese (chine): red/gold `['#B5171B', '#E9C46A']`
     - Indian (inde): saffron/orange `['#E9C46A', '#F4A261']`
     - French (france): blue/white `['#003087', '#7B8BA4']`
     - Italian (italie): green/red `['#009246', '#CE2B37']`
     - Mexican (mexique): warm orange `['#F4A261', '#E76F51']`
     - Moroccan (maroc): terracotta/gold `['#C1440E', '#F4D35E']`
     - Lebanese (liban): red/amber `['#D62828', '#F77F00']`
     - German (allemagne, allemand): dark gold `['#2C2C2C', '#DAA520']`
     - Korean (cor√©e, coree): deep red/white `['#C1272D', '#FFFFFF']`
     - Thai (tha√Ølande, thailande): gold/green `['#E9C46A', '#2D6A4F']`
     - Default: dark blue/slate `['#2C3E50', '#3498DB']`
   - `getCuisineGradient(origin: string | null): [string, string]` ‚Äî lowercase-match origin against keys, return first hit or default.
   - `CATEGORY_EMOJIS: Record<string, string>` for fallback: `{ entr√©e: 'ü•ó', plat: 'üçΩÔ∏è', dessert: 'üçÆ', salade: 'ü•ó', soupe: 'üçú', grill: 'ü•©', p√¢tes: 'üçù', pizza: 'üçï', default: 'üç¥' }`.
   - `getDishEmoji(category: string | null, ingredients: string[] | null): string` ‚Äî check first 3 ingredients against a small ingredient-to-emoji map (agneau‚Üíüêë, poulet‚Üíüçó, boeuf‚Üíü•©, poisson‚Üíüêü, riz‚Üíüçö, tomate‚ÜíüçÖ, fromage‚ÜíüßÄ, crevette‚Üíü¶ê), falling back to category emoji, then default 'üç¥'.

2. **`components/menu/DishImage.tsx`** ‚Äî 'use client' component:
   - Props: `{ src: string; alt: string; placeholder?: string | null; className?: string }`
   - Renders a square container with `next/image`:
     ```tsx
     <div className={`relative w-full aspect-square rounded-lg overflow-hidden ${className ?? ''}`}>
       <Image
         src={src}
         alt={alt}
         fill
         className="object-cover"
         placeholder={placeholder ? 'blur' : 'empty'}
         blurDataURL={placeholder ?? undefined}
         sizes="(max-width: 768px) calc(100vw - 2rem), 400px"
       />
     </div>
     ```
   - Import `Image` from `next/image`.

3. **`components/menu/DishImageFallback.tsx`** ‚Äî 'use client' component:
   - Props: `{ origin: string | null; category: string | null; ingredients: string[] | null; className?: string }`
   - Import `getCuisineGradient`, `getDishEmoji` from `@/lib/dish-fallback`.
   - Render a square gradient container with centered emoji:
     ```tsx
     const [from, to] = getCuisineGradient(origin);
     const emoji = getDishEmoji(category, ingredients);
     return (
       <div
         className={`relative w-full aspect-square rounded-lg overflow-hidden flex items-center justify-center ${className ?? ''}`}
         style={{ background: `linear-gradient(135deg, ${from}, ${to})` }}
       >
         <span className="text-4xl select-none">{emoji}</span>
       </div>
     );
     ```

4. **`components/menu/DishCard.tsx`** ‚Äî integrate image zone:
   - Import `DishImage` and `DishImageFallback`.
   - Add image zone BEFORE the name row, inside the card container, only for full-depth enriched items:
     ```tsx
     {/* Image zone ‚Äî full-depth items only */}
     {isFullDepth && item.image_url && (
       <button type="button" onClick={() => onTapDetail?.(item)} className="w-full">
         <DishImage
           src={item.image_url}
           alt={item.canonical_name ?? item.name_original}
           placeholder={item.image_placeholder}
         />
       </button>
     )}
     {isFullDepth && !item.image_url && (
       <button type="button" onClick={() => onTapDetail?.(item)} className="w-full">
         <DishImageFallback
           origin={item.enrichment_origin}
           category={item.category}
           ingredients={item.enrichment_ingredients}
         />
       </button>
     )}
     ```
   - The image/fallback is wrapped in a `<button>` that calls `onTapDetail` ‚Äî tapping the image opens the DishDetailSheet (per locked decision: no separate full-screen viewer).
   - Note: images are NOT shown for minimal-depth or pending items ‚Äî only full-depth enriched dishes get the visual treatment (Level 2 in the 3-level pattern).
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `DishCard.tsx` imports and renders both `DishImage` and `DishImageFallback`
- `lib/dish-fallback.ts` exports `getCuisineGradient` and `getDishEmoji`
- `DishImage.tsx` uses `next/image` with `fill`, `object-cover`, `placeholder="blur"`, and `blurDataURL`
- `DishImageFallback.tsx` renders a gradient + emoji
  </verify>
  <done>
Full-depth enriched DishCards display a square stock photo (blur-up via dominant color) or a cuisine-themed gradient+emoji fallback. Tapping either opens the DishDetailSheet. Basic and minimal-depth cards remain text-only.
  </done>
</task>

<task type="auto">
  <name>Task 2: DishDetailSheet image + attribution + polling hook update</name>
  <files>
    components/menu/DishDetailSheet.tsx
    hooks/useEnrichmentPolling.ts
    components/menu/MenuShell.tsx
  </files>
  <action>
1. **`components/menu/DishDetailSheet.tsx`** ‚Äî add image display and attribution:
   - Import `Image` from `next/image`.
   - Import `DishImageFallback` from `@/components/menu/DishImageFallback`.
   - At the top of the sheet content (before the dish name `<h2>`), add:
     ```tsx
     {/* Image in sheet ‚Äî larger view */}
     {item.image_url ? (
       <div className="relative w-full aspect-[4/3] rounded-lg overflow-hidden -mt-2">
         <Image
           src={item.image_url}
           alt={item.canonical_name ?? item.name_original}
           fill
           className="object-cover"
           placeholder={item.image_placeholder ? 'blur' : 'empty'}
           blurDataURL={item.image_placeholder ?? undefined}
           sizes="(max-width: 768px) 100vw, 500px"
         />
       </div>
     ) : item.enrichment_depth === 'full' ? (
       <DishImageFallback
         origin={item.enrichment_origin}
         category={item.category}
         ingredients={item.enrichment_ingredients}
         className="aspect-[4/3]"
       />
     ) : null}
     ```
   - Note: the sheet uses a 4:3 aspect ratio (not square) for a more immersive view. The `DishImageFallback` className override changes the fallback from square to 4:3 in the sheet context. Since `DishImageFallback` uses `aspect-square` in its default class, the `className` prop with `aspect-[4/3]` will need to override. Adjust `DishImageFallback` to accept a `className` that can override the aspect ratio ‚Äî use the pattern: the component applies `aspect-square` only if no `className` is passed that contains `aspect-`. Or simpler: remove `aspect-square` from the component's own classes and always require the parent to set aspect ratio via className. **Decision: always set aspect ratio from parent.** Update `DishImageFallback` to NOT include `aspect-square` in its own classes ‚Äî the parent always passes the aspect class (DishCard passes `aspect-square`, DishDetailSheet passes `aspect-[4/3]`). Same for `DishImage` ‚Äî remove `aspect-square` from the component, let parent control. Update DishCard's usage to wrap in a container with `aspect-square`, or pass `className="aspect-square"`.

   **Revised approach for DishImage and DishImageFallback:**
   - Both components render without a fixed aspect ratio in their own classes. The wrapping container in DishCard and DishDetailSheet provides the aspect ratio.
   - DishImage: `<div className={\`relative w-full rounded-lg overflow-hidden ${className ?? 'aspect-square'}\`}>`
   - DishImageFallback: `<div className={\`relative w-full rounded-lg overflow-hidden flex items-center justify-center ${className ?? 'aspect-square'}\`}>`
   - DishCard passes no className (gets default `aspect-square`)
   - DishDetailSheet passes `className="aspect-[4/3]"`

   - At the bottom of the sheet content (after eating tips), add attribution (only when image exists):
     ```tsx
     {/* Photo credit ‚Äî shown in sheet only, per user decision */}
     {item.image_url && item.image_credit && item.image_credit_url && (
       <a
         href={item.image_credit_url}
         target="_blank"
         rel="noopener noreferrer"
         className="text-brand-muted/50 text-[11px] hover:text-brand-muted/70 transition-colors"
       >
         {item.image_credit}
       </a>
     )}
     ```
   - This satisfies both Unsplash and Pexels attribution requirements: photographer name linked to their profile page.

2. **`hooks/useEnrichmentPolling.ts`** ‚Äî extend poll termination to include images:
   - Currently, polling stops when no food items have `enrichment_status === 'pending'`.
   - Update the `hasPendingFoodItems` function to ALSO consider full-depth items without images as "still pending" ‚Äî but only if the enrichment itself is done. The logic:
     ```typescript
     const hasPendingWork = useCallback((itemList: MenuItem[]) =>
       itemList.some(i =>
         !i.is_beverage && (
           i.enrichment_status === 'pending' ||
           (i.enrichment_status === 'enriched' && i.enrichment_depth === 'full' && !i.image_url)
         )
       ),
     []);
     ```
   - Rename the callback from `hasPendingFoodItems` to `hasPendingWork` for clarity.
   - Also update the stop-polling condition inside the poll function to match: `data.items.some(d => d.enrichment_status === 'pending' || (d.enrichment_status === 'enriched' && d.enrichment_depth === 'full' && !d.image_url))`.
   - Add a safety timeout: if polling has been running for > 60 seconds (20 cycles at 3s), stop regardless. This prevents infinite polling if image fetch fails silently. Track poll start time with a ref: `const startRef = useRef(Date.now())`. In the poll function, check `if (Date.now() - startRef.current > 60_000)` and clear interval.

3. **`components/menu/MenuShell.tsx`** ‚Äî ensure image fields merge correctly:
   - The existing `useMemo` merge in MenuShell spreads polled enrichment fields onto `menuData.menu_items`. Since the status endpoint now returns image fields, they will automatically merge via the `{ ...item, ...fresh }` spread in `useEnrichmentPolling`. No changes needed in MenuShell's merge logic ‚Äî the image fields are non-overlapping with translation fields, so the existing pattern works.
   - **Verify**: read MenuShell to confirm no explicit field filtering. If the useMemo only merges specific enrichment fields (cherry-picking), add the 5 image fields to the merge. If it spreads the full object, no change needed.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` passes
- DishDetailSheet renders image at top + attribution link at bottom
- useEnrichmentPolling stops polling when all full-depth items have image_url OR after 60s timeout
- No explicit image field filtering in MenuShell merge logic
  </verify>
  <done>
DishDetailSheet displays a 4:3 image at the top with photo credit link at the bottom. Polling continues until images arrive for full-depth dishes (with a 60s safety timeout). The full 3-level image pattern is implemented: basic=no image, detail=square image on card, advanced=4:3 image with attribution in sheet.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of dish images</name>
  <what-built>
    Dish image display with blur-up loading, cuisine-based gradient fallback, and photographer attribution. Three levels of detail:
    1. Basic/minimal DishCards: no image (text only)
    2. Detail DishCards (full-depth enriched): square stock photo or gradient+emoji fallback
    3. DishDetailSheet: 4:3 image with photo credit link at bottom
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Scan a Turkish menu: `https://menu.eazee-link.com/?id=E7FNRP0ET3&o=q`
    3. Wait ~15-20 seconds for enrichment + image fetch to complete
    4. Verify DishCards:
       - Full-depth dishes (e.g., Mantƒ±, Lahmacun) show a square stock photo with blur-up effect
       - If any dish has no Unsplash/Pexels result, verify it shows a warm-toned gradient with food emoji (not a broken image)
       - Minimal-depth dishes (e.g., steak frites if present) show no image ‚Äî text only
       - Beverages show no image
    5. Tap a dish image ‚Üí DishDetailSheet opens with:
       - Larger 4:3 image at top
       - Dish name, origin, cultural note, ingredients, eating tips (same as before)
       - "Photo by X on Unsplash/Pexels" credit link at bottom
    6. Click the credit link ‚Üí opens photographer profile in new tab
    7. Verify no broken images anywhere ‚Äî all dishes show either a photo or gradient+emoji
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` ‚Äî zero errors
2. `npm run build` ‚Äî all pages build
3. DishCard shows square image for full-depth dishes with image_url
4. DishCard shows gradient+emoji for full-depth dishes without image_url
5. DishDetailSheet shows 4:3 image with attribution
6. Polling continues until images arrive (or 60s timeout)
7. No broken images or empty states
</verification>

<success_criteria>
- A DishCard for "Mantƒ±" displays a photo from Unsplash or Pexels with blur-up loading
- A DishCard for an obscure dish with no result displays a gradient+emoji fallback ‚Äî no broken image
- Image credit is visible in DishDetailSheet and links to photographer profile
- The three-level detail pattern works: basic=text, detail=square image, advanced=sheet with 4:3 image + credit
</success_criteria>

<output>
After completion, create `.planning/phases/12-dish-images/12-02-SUMMARY.md`
</output>
