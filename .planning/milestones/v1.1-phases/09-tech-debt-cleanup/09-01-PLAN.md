---
phase: 09-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/models.ts
  - app/actions/admin.ts
  - components/admin/AdminDashboard.tsx
  - lib/types/menu.ts
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
  - .planning/phases/05-scan-pipeline/05-VERIFICATION.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "ALLOWED_MODELS is defined in exactly one file (lib/models.ts) — no duplicates in admin.ts or AdminDashboard.tsx"
    - "Menu TypeScript interface includes hit_count and parse_time_ms fields matching the database schema"
    - "Phase 5 has a VERIFICATION.md documenting scan pipeline requirement coverage (SCAN-01 through SCAN-05, INFR-04)"
    - "All REQUIREMENTS.md checkboxes reflect actual implementation status — zero false negatives"
    - "ROADMAP.md progress table shows phases 4, 5, 8 as complete (not 'Not started')"
  artifacts:
    - path: "lib/models.ts"
      provides: "Single source of truth for ALLOWED_MODELS constant and AllowedModel type"
      contains: "ALLOWED_MODELS"
    - path: "lib/types/menu.ts"
      provides: "Menu interface with hit_count and parse_time_ms fields"
      contains: "hit_count"
    - path: ".planning/phases/05-scan-pipeline/05-VERIFICATION.md"
      provides: "Phase 5 scan pipeline verification document"
      contains: "SCAN-01"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated requirement checkboxes matching implementation reality"
      contains: "DISH-02"
    - path: ".planning/ROADMAP.md"
      provides: "Updated progress table with phases 4-8 completion status"
      contains: "Complete"
  key_links:
    - from: "app/actions/admin.ts"
      to: "lib/models.ts"
      via: "import { ALLOWED_MODELS }"
      pattern: "import.*ALLOWED_MODELS.*from.*@/lib/models"
    - from: "components/admin/AdminDashboard.tsx"
      to: "lib/models.ts"
      via: "import { ALLOWED_MODELS }"
      pattern: "import.*ALLOWED_MODELS.*from.*@/lib/models"
---

<objective>
Resolve 4 tech debt items from the v1.1 audit: deduplicate ALLOWED_MODELS into a shared module, add missing fields to the Menu TypeScript interface, create Phase 5 VERIFICATION.md, and sync all documentation checkboxes to reality.

Purpose: Close all tech debt identified in the v1.1 milestone audit so the codebase is clean and documentation is accurate.
Output: 1 new shared module, 1 updated type, 1 new verification doc, 2 updated planning docs.
</objective>

<execution_context>
@/Users/ekitcho/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ekitcho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tech-debt-cleanup/09-RESEARCH.md
@lib/types/menu.ts
@app/actions/admin.ts
@components/admin/AdminDashboard.tsx
@lib/data.ts
@supabase/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deduplicate ALLOWED_MODELS and fix Menu type</name>
  <files>
    lib/models.ts
    app/actions/admin.ts
    components/admin/AdminDashboard.tsx
    lib/types/menu.ts
  </files>
  <action>
**ALLOWED_MODELS deduplication:**

1. Create `lib/models.ts` (NEW file — NO `'use server'` or `'use client'` directive). Content:
   - Comment: `// Shared LLM model constants — no directive, safe for server actions and client components`
   - Export `const ALLOWED_MODELS = ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1-mini'] as const;`
   - Export `type AllowedModel = typeof ALLOWED_MODELS[number];`
   - Add JSDoc explaining single-source-of-truth purpose

2. In `app/actions/admin.ts`:
   - Add `import { ALLOWED_MODELS } from '@/lib/models';`
   - Remove the local `const ALLOWED_MODELS = ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1-mini'] as const;` line
   - Leave everything else unchanged

3. In `components/admin/AdminDashboard.tsx`:
   - Add `import { ALLOWED_MODELS } from '@/lib/models';`
   - Remove the local `const ALLOWED_MODELS = ['gpt-4o', 'gpt-4o-mini', 'gpt-4.1-mini'] as const;` line
   - Leave everything else unchanged

**Menu type fix:**

4. In `lib/types/menu.ts`, add two fields to the `Menu` interface (insert BEFORE `parsed_at`):
   - `parse_time_ms: number | null;` (integer nullable in schema — null for cache hits)
   - `hit_count: number;` (integer NOT NULL default 0 in schema)

5. Do NOT remove `source_language: string | null` — it is actively used by `lib/cache.ts`.

6. Run `npx tsc --noEmit` to verify zero TypeScript errors after all changes.
  </action>
  <verify>
- `npx tsc --noEmit` exits 0 (no type errors)
- `grep -r "const ALLOWED_MODELS" lib/models.ts` returns exactly 1 match
- `grep -r "const ALLOWED_MODELS" app/actions/admin.ts components/admin/AdminDashboard.tsx` returns 0 matches (removed)
- `grep "hit_count" lib/types/menu.ts` returns a match
- `grep "parse_time_ms" lib/types/menu.ts` returns a match
- `head -3 lib/models.ts` does NOT contain 'use server' or 'use client'
  </verify>
  <done>
ALLOWED_MODELS defined in exactly one file (lib/models.ts), imported by both admin.ts and AdminDashboard.tsx. Menu interface includes hit_count and parse_time_ms. TypeScript compiles with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 5 VERIFICATION.md and sync documentation</name>
  <files>
    .planning/phases/05-scan-pipeline/05-VERIFICATION.md
    .planning/REQUIREMENTS.md
    .planning/ROADMAP.md
  </files>
  <action>
**Phase 5 VERIFICATION.md:**

1. Create `.planning/phases/05-scan-pipeline/05-VERIFICATION.md` using the same format as `04-VERIFICATION.md` and `08-VERIFICATION.md`. Include:
   - YAML frontmatter: `phase: 05-scan-pipeline`, `verified: 2026-02-26`, `status: passed`, `score: 6/6`
   - Observable Truths table covering all 6 requirements with status and evidence:
     - SCAN-01: QR code scan → `components/scan/QrScanner.tsx` dynamic imports `qr-scanner`, dispatches `qr-decoded` event
     - SCAN-02: URL paste scan → `components/scan/UrlInput.tsx` → `POST /api/scan/url` → `getOrParseMenu`
     - SCAN-03: Photo OCR scan → `components/scan/PhotoUpload.tsx` → `POST /api/scan/photo` → GPT-4o Vision
     - SCAN-04: Loading progress feedback → `components/scan/ScanProgress.tsx` 4-step indicator
     - SCAN-05: Cache repeat scans → `lib/cache.ts` `getOrParseMenu` cache-first check
     - INFR-04: Image resize 1024px → `components/scan/PhotoUpload.tsx` uses `browser-image-compression` with `maxWidthOrHeight: 1024`
   - Required Artifacts table listing all scan pipeline files (see research for full list)
   - Key Link Verification table (QR→URL handoff, URL→API→cache, Photo→API→Vision, Progress overlay)
   - Requirements Coverage table mapping each requirement to its implementation
   - Human Verification Required section listing 5 items that need live testing (QR camera, URL parse, photo parse, cache behavior, loading indicator)
   - Gaps Summary: None (all requirements code-complete per 05-01-SUMMARY.md and 05-02-SUMMARY.md)

**REQUIREMENTS.md checkbox sync:**

2. Read `.planning/REQUIREMENTS.md` and make these specific changes:
   - DISH-02 checkbox: `[ ]` → `[x]` (Phase 8 completed the eazee-link translation fix)
   - INFR-04 checkbox: `[ ]` → `[x]` (code complete per 05-02-SUMMARY.md)
   - INFR-05 checkbox: `[ ]` → `[x]` (satisfied per 07-VERIFICATION.md)
   - Traceability table: DISH-02 status `Pending` → `Complete`
   - Coverage summary: Update count to "Complete: 23, Pending: 0" (all requirements satisfied)

**ROADMAP.md progress sync:**

3. Read `.planning/ROADMAP.md` and make these specific changes:
   - Phase bullets (lines ~25-30):
     - Phase 4: `- [ ]` → `- [x]`
     - Phase 5: `- [ ]` → `- [x]`
     - Phase 8: `- [ ]` → `- [x]`
   - Phase detail plan bullets: Update all `- [ ]` to `- [x]` for phases 4, 5, 7, 8 plan items (04-01, 04-02, 05-01, 05-02, 07-01, 07-02, 08-01)
   - Progress table:
     - Phase 4: `0/2 | Not started` → `2/2 | Complete | 2026-02-25`
     - Phase 5: `0/TBD | Not started` → `2/2 | Complete | 2026-02-25`
     - Phase 8: `0/1 | Not started` → `1/1 | Complete | 2026-02-26`
  </action>
  <verify>
- `.planning/phases/05-scan-pipeline/05-VERIFICATION.md` exists and contains frontmatter with `status: passed`
- `grep -c "SCAN-0" .planning/phases/05-scan-pipeline/05-VERIFICATION.md` returns at least 5 (all SCAN requirements referenced)
- `grep "INFR-04" .planning/phases/05-scan-pipeline/05-VERIFICATION.md` returns a match
- `grep -c "\[ \]" .planning/REQUIREMENTS.md` returns 0 for the requirements section (all checked)
- `grep "Not started" .planning/ROADMAP.md` returns only Phase 9 (which is current, not yet complete)
- `grep "Complete: 23" .planning/REQUIREMENTS.md` returns a match
  </verify>
  <done>
Phase 5 VERIFICATION.md created with full requirement coverage. REQUIREMENTS.md shows 23/23 requirements complete with zero pending. ROADMAP.md progress table accurately reflects phases 4-8 as complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `grep -rn "const ALLOWED_MODELS" lib/ app/ components/` — exactly 1 result (lib/models.ts)
3. `grep "hit_count\|parse_time_ms" lib/types/menu.ts` — both fields present
4. `ls .planning/phases/05-scan-pipeline/05-VERIFICATION.md` — file exists
5. All REQUIREMENTS.md checkboxes checked (no false `[ ]` for implemented features)
6. ROADMAP.md progress table shows phases 4, 5, 6, 7, 8 as Complete
</verification>

<success_criteria>
- ALLOWED_MODELS exists in one shared location only — zero duplication
- Menu type matches database schema (hit_count, parse_time_ms present)
- Phase 5 verification document exists with all 6 requirement mappings
- REQUIREMENTS.md and ROADMAP.md accurately reflect implementation reality
- TypeScript compilation succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-tech-debt-cleanup/09-01-SUMMARY.md`
</output>
